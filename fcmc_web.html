import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, collection, query, updateDoc, addDoc, getDocs, setLogLevel, setDoc } from 'firebase/firestore';

// Main App component that manages all the pages and state
export default function App() {
  const [currentPage, setCurrentPage] = useState('home');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [selectedPosition, setSelectedPosition] = useState(null);
  const [theme, setTheme] = useState('dark');
  const [redeemCodes, setRedeemCodes] = useState([]);
  const [isEditor, setIsEditor] = useState(false);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [copiedCodeId, setCopiedCodeId] = useState(null); // New state to track the copied code
  const [editorContent, setEditorContent] = useState('');
  const [playersData, setPlayersData] = useState([]);
  const [top10PlayersData, setTop10PlayersData] = useState({});
  
  // This is the editor's ID. To log in as an editor, paste your ID here.
  // The user's UID is displayed on the top right when logged in.
  const editorId = "06368865647689072591";

  // Firestore initialization and authentication
  useEffect(() => {
    // Set Firebase debug log level
    setLogLevel('debug');
    
    // Firebase App ID
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // Firebase configuration
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    // Firebase custom auth token
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
    
    // Initial data for the editor content, including the new player review
    const initialEditorData = {
      "playersData": [
        {
          "id": "vini-jr-id",
          "name": "Vinícius Júnior",
          "position": "LW",
          "rating": 98,
          "image": "https://placehold.co/400x400/22c55e/ffffff?text=Vinicius+Jr",
          "weakFoot": 4,
          "skillMoves": 5,
          "stamina": 92,
          "review": {
            "overallRating": 9.5,
            "strengths": [
              "Blazing pace and acceleration",
              "Exceptional dribbling and skill moves",
              "Strong shooting with both feet",
              "Excellent ball control"
            ],
            "weaknesses": [
              "Can be easily pushed off the ball sometimes"
            ],
            "summary": "Vinícius Júnior is a phenomenal winger, offering explosive pace and world-class dribbling. He is a game-changer on the attack and can create chances out of nothing. A top-tier choice for any team."
          }
        },
        {
          "id": "kdb-id",
          "name": "Kevin De Bruyne",
          "position": "CAM",
          "rating": 95,
          "image": "https://placehold.co/400x400/22c55e/ffffff?text=KDB",
          "weakFoot": 5,
          "skillMoves": 4,
          "stamina": 88,
          "review": {
            "overallRating": 9.8,
            "strengths": [
              "Unrivaled passing and vision",
              "Powerful long-range shots",
              "High work rate and stamina",
              "Excellent crossing ability"
            ],
            "weaknesses": [
              "Slightly lower pace compared to other midfielders"
            ],
            "summary": "Kevin De Bruyne is the ultimate creative force. His passing range and shot power are second to none, making him a must-have for any midfield. He dictates the tempo of the game and can score from anywhere on the pitch."
          }
        },
        {
          "id": "mbappe-id",
          "name": "Kylian Mbappé",
          "position": "ST",
          "rating": 99,
          "image": "https://placehold.co/400x400/22c55e/ffffff?text=Mbappe",
          "weakFoot": 5,
          "skillMoves": 5,
          "stamina": 95,
          "review": {
            "overallRating": 10,
            "strengths": [
              "Unbelievable speed and acceleration",
              "Clinical finishing and shooting",
              "Exceptional dribbling and close control",
              "Versatility to play as a winger or striker"
            ],
            "weaknesses": [
              "Can be inconsistent in some matches"
            ],
            "summary": "Kylian Mbappé is a generational talent and arguably the best player in the game. His raw pace combined with his elite finishing makes him unstoppable. He's the perfect striker for any team and a true goal machine."
          }
        },
        {
          "id": "messi-id",
          "name": "Lionel Messi",
          "position": "RW",
          "rating": 96,
          "image": "https://placehold.co/400x400/22c55e/ffffff?text=Messi",
          "weakFoot": 4,
          "skillMoves": 4,
          "stamina": 85,
          "review": {
            "overallRating": 9.7,
            "strengths": [
              "Unmatched dribbling and agility",
              "Incredible passing and vision",
              "Precise finishing",
              "Exceptional free-kick ability"
            ],
            "weaknesses": [
              "Lower pace and physical strength"
            ],
            "summary": "Lionel Messi is a master of the game. His ability to weave through defenses and create chances is unparalleled. While his physical stats might not be the highest, his technical skills more than make up for it."
          }
        }
      ],
      "top10PlayersData": {
        "ST": [
          {
            "id": "mbappe-id",
            "name": "Kylian Mbappé",
            "position": "ST",
            "rating": 99,
            "image": "https://placehold.co/400x400/22c55e/ffffff?text=Mbappe",
            "weakFoot": 5,
            "skillMoves": 5,
            "stamina": 95
          }
        ],
        "RW": [
          {
            "id": "vini-jr-id",
            "name": "Vinícius Júnior",
            "position": "LW",
            "rating": 98,
            "image": "https://placehold.co/400x400/22c55e/ffffff?text=Vinicius+Jr",
            "weakFoot": 4,
            "skillMoves": 5,
            "stamina": 92
          },
          {
            "id": "messi-id",
            "name": "Lionel Messi",
            "position": "RW",
            "rating": 96,
            "image": "https://placehold.co/400x400/22c55e/ffffff?text=Messi",
            "weakFoot": 4,
            "skillMoves": 4,
            "stamina": 85
          }
        ],
        "CAM": [
          {
            "id": "kdb-id",
            "name": "Kevin De Bruyne",
            "position": "CAM",
            "rating": 95,
            "image": "https://placehold.co/400x400/22c55e/ffffff?text=KDB",
            "weakFoot": 5,
            "skillMoves": 4,
            "stamina": 88
          }
        ],
        "LW": [],
        "CF": [],
        "CM": [],
        "CDM": [],
        "CB": [],
        "LB": [],
        "RB": [],
        "GK": []
      }
    };
    
    try {
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);

      setAuth(authInstance);
      setDb(dbInstance);

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        setUser(user);
        if (user) {
          const userId = user.uid;
          setIsEditor(userId === editorId);
          console.log("User signed in with ID:", userId);

          try {
            // Firestore document references
            const codesRef = collection(dbInstance, `artifacts/${appId}/public/data/redeemCodes`);
            const editorDocRef = doc(dbInstance, `artifacts/${appId}/public/data/editor_data`, 'editor_content');

            // Set up real-time listener for the editor content
            const unsubscribeEditorContent = onSnapshot(editorDocRef, (docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                setEditorContent(data.content);
                try {
                  const parsedContent = JSON.parse(data.content);
                  setPlayersData(parsedContent.playersData || []);
                  setTop10PlayersData(parsedContent.top10PlayersData || {});
                } catch (e) {
                  console.error("Failed to parse editor content JSON:", e);
                }
              } else {
                console.log("No editor content found, initializing with empty data.");
                setEditorContent(JSON.stringify(initialEditorData, null, 2));
                setPlayersData(initialEditorData.playersData);
                setTop10PlayersData(initialEditorData.top10PlayersData);
                // Optionally save the initial data to Firestore
                setDoc(editorDocRef, { content: JSON.stringify(initialEditorData) });
              }
              setLoading(false);
            }, (error) => {
              console.error("Error fetching editor content:", error);
            });
            
            // Set up the real-time listener for redeem codes
            const codesQuery = query(codesRef);
            const unsubscribeSnapshot = onSnapshot(codesQuery, (snapshot) => {
              const codes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setRedeemCodes(codes);
              setLoading(false);
            }, (error) => {
              console.error("Error fetching real-time redeem codes:", error);
            });
            
            // Check if redeem code collection is empty and add initial data if needed
            const codesSnapshot = await getDocs(codesRef);
            if (codesSnapshot.empty) {
                console.log("Adding initial redeem codes to Firestore.");
                const initialCodes = [
                  { code: 'WELCOMETOFCMOBILE', isAvailable: true, rewardDescription: '1000 Gems' },
                  { code: 'FCMOBILE2024GIFT', isAvailable: true, rewardDescription: 'Elite Player Pack' },
                  { code: 'EPICPACK123', isAvailable: true, rewardDescription: '500 Skill Boosts' },
                  { code: 'FREECOINS99', isAvailable: false, rewardDescription: '500,000 Coins' },
                ];
                for (const code of initialCodes) {
                    await addDoc(codesRef, code);
                }
            }

            // Return a cleanup function for both listeners
            return () => {
              unsubscribeEditorContent();
              unsubscribeSnapshot();
            };
          } catch (error) {
            console.error("Error accessing Firestore data:", error);
          }
        } else {
          setIsEditor(false);
          setLoading(false);
          console.log("User signed out.");
        }
      });
      
      const signIn = async () => {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(authInstance, initialAuthToken);
          } else {
            await signInAnonymously(authInstance);
          }
        } catch (error) {
          console.error("Firebase authentication failed during sign-in:", error);
        }
      };
      signIn();

      return () => unsubscribe(); // Cleanup the auth state listener on unmount
    } catch (error) {
      console.error("Firebase initialization failed:", error);
    }
  }, []);

  // Function to copy text to the clipboard and update the button text
  const copyToClipboard = (text, id) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);

    // Set the copied code ID to show "Copied!"
    setCopiedCodeId(id);

    // After 15 seconds, reset the copiedCodeId to null
    setTimeout(() => {
      setCopiedCodeId(null);
    }, 15000); // 15 seconds
  };
  
  // Function to toggle code availability
  const toggleCodeAvailability = async (codeId, isAvailable) => {
    try {
      if (!db) {
        console.error("Firestore not initialized.");
        return;
      }
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const codeDocRef = doc(db, `artifacts/${appId}/public/data/redeemCodes`, codeId);
      await updateDoc(codeDocRef, {
        isAvailable: !isAvailable
      });
    } catch (error) {
      console.error("Error updating redeem code:", error);
    }
  };

  const positions = ['ST', 'RW', 'LW', 'CF', 'CAM', 'CM', 'CDM', 'CB', 'LB', 'RB', 'GK'];

  // Function to toggle between dark and light themes
  const toggleTheme = () => {
    setTheme(theme === 'dark' ? 'light' : 'dark');
  };

  // Custom modal message box
  const showModalMessage = (message) => {
    // Add logic for a custom modal here
    // For now, we will use a simple console log
    console.log(message);
  };

  // Navigation component
  const Navigation = () => (
    <nav className={`py-3 mt-4 ${theme === 'dark' ? 'bg-gray-800' : 'bg-gray-200'}`}>
      <div className="container mx-auto px-4">
        <ul className="flex flex-wrap justify-center space-x-2 sm:space-x-6 text-sm font-medium">
          <li><button onClick={() => setCurrentPage('home')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Home</button></li>
          <li><button onClick={() => setCurrentPage('playerReviews')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Player Reviews</button></li>
          <li><button onClick={() => setCurrentPage('top10Players')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Top 10 Players</button></li>
          <li><button onClick={() => setCurrentPage('redeemCode')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Redeem Codes</button></li>
          {isEditor && (
            <li><button onClick={() => setCurrentPage('editor')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Editor Dashboard</button></li>
          )}
          <li><button onClick={() => setCurrentPage('contact')} className={`hover:text-blue-400 transition-colors duration-200 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Contact</button></li>
        </ul>
      </div>
    </nav>
  );

  // Home page component
  const HomePage = () => (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <Card title="Player Reviews" description="Find detailed reviews and statistics for various players." onClick={() => setCurrentPage('playerReviews')} />
      <Card title="Top 10 Players" description="See the top 10 players for each position in the game." onClick={() => setCurrentPage('top10Players')} />
      <Card title="Redeem Codes" description="Get the latest available and unavailable redeem codes." onClick={() => setCurrentPage('redeemCode')} />
      <Card title="Contact" description="Get in touch with us through our social media." onClick={() => setCurrentPage('contact')} />
    </div>
  );
  
  // Card component
  const Card = ({ title, description, onClick }) => (
    <div onClick={onClick} className={`${theme === 'dark' ? 'bg-[#1c1c1c] text-gray-400' : 'bg-white text-gray-700'} rounded-lg p-6 shadow-xl hover:bg-gray-800 transition-colors duration-200 cursor-pointer`}>
      <h3 className="text-xl font-semibold text-blue-400">{title}</h3>
      <p className="mt-2">{description}</p>
    </div>
  );

  // Player Reviews page
  const PlayerReviewsPage = () => {
    const filteredPlayers = playersData.filter(player =>
      player.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      player.position.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-semibold text-blue-400">Player Reviews</h2>
        <div className={`rounded-lg p-4 shadow-xl mb-4 ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
          <input
            type="text"
            placeholder="Search by player name or position..."
            className="w-full p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {filteredPlayers.length > 0 ? (
            filteredPlayers.map(player => (
              <PlayerCard key={player.id} player={player} onClick={() => { setCurrentPage('playerDetail'); setSelectedPlayer(player); }} />
            ))
          ) : (
            <p className={`text-center col-span-full ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>No players found.</p>
          )}
        </div>
      </div>
    );
  };

  // Player card component
  const PlayerCard = ({ player, onClick }) => (
    <div onClick={onClick} className={`${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-white'} rounded-lg p-4 shadow-xl hover:bg-gray-800 transition-colors duration-200 cursor-pointer text-center`}>
      <img src={player.image} alt={player.name} className="w-full h-auto rounded-md mb-2 object-cover" />
      <h4 className="text-lg font-bold text-blue-400">{player.name}</h4>
      <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{player.position} | Rating: {player.rating}</p>
    </div>
  );

  // Player Detail page
  const PlayerDetailPage = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-semibold text-blue-400">Player Review for {selectedPlayer.name}</h2>
      <div className={`${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-white'} rounded-lg p-6 shadow-xl flex flex-col md:flex-row items-center md:items-start gap-6`}>
        <img src={selectedPlayer.image} alt={selectedPlayer.name} className="w-48 h-auto rounded-lg object-cover shadow-lg" />
        <div className="flex-1">
          <h3 className="text-3xl font-bold text-blue-400 mb-2">{selectedPlayer.name}</h3>
          <p className={`text-lg ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Position: <span className="font-semibold">{selectedPlayer.position}</span></p>
          <p className={`text-lg ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Overall Rating: <span className="font-semibold">{selectedPlayer.review.overallRating}</span></p>
          <p className={`text-lg ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Weak Foot: <span className="font-semibold">{selectedPlayer.weakFoot}</span>/5</p>
          <p className={`text-lg ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Skill Moves: <span className="font-semibold">{selectedPlayer.skillMoves}</span>/5</p>
          <p className={`text-lg ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Stamina: <span className="font-semibold">{selectedPlayer.stamina}</span></p>
          
          <div className="mt-6 space-y-4">
            <h4 className="text-xl font-bold text-blue-400">Review Breakdown:</h4>
            
            <div>
              <h5 className="text-lg font-semibold text-green-400">Strengths:</h5>
              <ul className="list-disc list-inside space-y-1">
                {selectedPlayer.review.strengths.map((strength, index) => (
                  <li key={index} className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{strength}</li>
                ))}
              </ul>
            </div>
            
            <div>
              <h5 className="text-lg font-semibold text-red-400">Weaknesses:</h5>
              <ul className="list-disc list-inside space-y-1">
                {selectedPlayer.review.weaknesses.map((weakness, index) => (
                  <li key={index} className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{weakness}</li>
                ))}
              </ul>
            </div>
            
            <div>
              <h5 className="text-lg font-semibold text-blue-400">Summary:</h5>
              <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{selectedPlayer.review.summary}</p>
            </div>
          </div>
        </div>
      </div>
      <button onClick={() => setCurrentPage('playerReviews')} className={`mt-4 ${theme === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-300 hover:bg-gray-400'} text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200`}>
        Go Back
      </button>
    </div>
  );

  // Top 10 Players page
  const Top10PlayersPage = () => {
    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-semibold text-blue-400">Top 10 Players</h2>
        <div className={`flex flex-wrap gap-2 justify-center rounded-lg p-4 shadow-xl ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
          {positions.map(pos => (
            <button
              key={pos}
              onClick={() => setSelectedPosition(pos)}
              className={`py-2 px-4 rounded-lg font-semibold transition-colors duration-200 ${selectedPosition === pos ? 'bg-blue-600 text-white' : `${theme === 'dark' ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}`}
            >
              {pos}
            </button>
          ))}
        </div>
        
        {selectedPosition && (
          <div className="mt-6">
            <h3 className={`text-xl font-semibold ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Position: {selectedPosition}</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-4">
              {top10PlayersData[selectedPosition] ? (
                top10PlayersData[selectedPosition].map((player, index) => (
                  <div key={player.id} className={`${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-white'} rounded-lg p-4 shadow-xl text-center`}>
                    <p className="text-lg font-bold text-yellow-400 mb-2">#{index + 1}</p>
                    <img src={player.image} alt={player.name} className="w-full h-auto rounded-md mb-2 object-cover" />
                    <h4 className="text-lg font-bold text-blue-400">{player.name}</h4>
                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Weak Foot: {player.weakFoot}</p>
                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Skill Moves: {player.skillMoves}</p>
                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Stamina: {player.stamina}</p>
                  </div>
                ))
              ) : (
                <p className={`col-span-full text-center ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>No players found for this position.</p>
              )}
            </div>
          </div>
        )}
      </div>
    );
  };

  // Redeem Code page (previously Rewards page)
  const RedeemCodePage = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-semibold text-blue-400">Redeem Codes</h2>
      <div className={`rounded-lg p-6 shadow-xl ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
        <div className="space-y-4">
          {loading ? (
            <p className="text-center text-gray-400">Loading codes...</p>
          ) : (
            redeemCodes.map((item, index) => (
              <div key={item.id} className={`flex items-center justify-between py-3 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-300'} last:border-b-0`}>
                <div className="flex-1">
                  <span className={`text-lg font-mono ${item.isAvailable ? 'text-green-400' : 'text-red-400 line-through'}`}>
                    {item.code}
                  </span>
                  <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                    Reward: {item.rewardDescription}
                  </p>
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={() => copyToClipboard(item.code, item.id)}
                    className={`font-medium py-1 px-3 rounded-lg text-sm transition-colors duration-200 ${copiedCodeId === item.id ? 'bg-green-600 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                  >
                    {copiedCodeId === item.id ? 'Copied!' : 'Copy'}
                  </button>
                  {isEditor && (
                    <button
                      onClick={() => toggleCodeAvailability(item.id, item.isAvailable)}
                      className={`py-1 px-3 rounded-lg text-sm transition-colors duration-200 ${item.isAvailable ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`}
                    >
                      {item.isAvailable ? 'Mark as Unavailable' : 'Mark as Available'}
                    </button>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );

  // Editor Dashboard Page
  const EditorPage = () => {
    const [newCode, setNewCode] = useState({ code: '', rewardDescription: '' });
    const [newPlayer, setNewPlayer] = useState({
      id: '', name: '', position: '', rating: '', image: '', weakFoot: '', skillMoves: '', stamina: '',
      review: { overallRating: '', strengths: '', weaknesses: '', summary: '' }
    });

    // Function to save the full content to Firestore
    const saveContent = async (updatedContent) => {
      try {
        if (!db) {
          console.error("Firestore not initialized.");
          return;
        }
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const editorDocRef = doc(db, `artifacts/${appId}/public/data/editor_data`, 'editor_content');
        await setDoc(editorDocRef, { content: updatedContent });
        showModalMessage('Content saved successfully!');
      } catch (error) {
        console.error("Error saving content:", error);
        showModalMessage('Failed to save content.');
      }
    };
    
    // Function to handle changes in the new player form
    const handleNewPlayerChange = (e) => {
      const { name, value } = e.target;
      if (name.includes('.')) {
        const [parent, child] = name.split('.');
        setNewPlayer(prev => ({
          ...prev,
          [parent]: {
            ...prev[parent],
            [child]: value
          }
        }));
      } else {
        setNewPlayer(prev => ({ ...prev, [name]: value }));
      }
    };

    // Function to add a new player review
    const addNewPlayerReview = () => {
      try {
        const parsedContent = JSON.parse(editorContent);
        const updatedPlayers = [...parsedContent.playersData, {
          ...newPlayer,
          rating: Number(newPlayer.rating),
          weakFoot: Number(newPlayer.weakFoot),
          skillMoves: Number(newPlayer.skillMoves),
          stamina: Number(newPlayer.stamina),
          review: {
            ...newPlayer.review,
            overallRating: Number(newPlayer.review.overallRating),
            strengths: newPlayer.review.strengths.split(',').map(s => s.trim()),
            weaknesses: newPlayer.review.weaknesses.split(',').map(s => s.trim())
          }
        }];
        const updatedData = { ...parsedContent, playersData: updatedPlayers };
        const updatedContentString = JSON.stringify(updatedData, null, 2);
        setEditorContent(updatedContentString);
        saveContent(updatedContentString);
      } catch (e) {
        console.error("Failed to add new player review:", e);
        showModalMessage("Failed to add new player. Please check your inputs.");
      }
    };

    // Function to remove a player review
    const removePlayerReview = (playerId) => {
      try {
        const parsedContent = JSON.parse(editorContent);
        const updatedPlayers = parsedContent.playersData.filter(p => p.id !== playerId);
        const updatedTop10 = Object.fromEntries(
          Object.entries(parsedContent.top10PlayersData).map(([pos, players]) => [
            pos,
            players.filter(p => p.id !== playerId)
          ])
        );
        const updatedData = { playersData: updatedPlayers, top10PlayersData: updatedTop10 };
        const updatedContentString = JSON.stringify(updatedData, null, 2);
        setEditorContent(updatedContentString);
        saveContent(updatedContentString);
      } catch (e) {
        console.error("Failed to remove player review:", e);
        showModalMessage("Failed to remove player.");
      }
    };

    // Function to add a new redeem code
    const addNewCode = async () => {
      if (!db || !newCode.code || !newCode.rewardDescription) {
        showModalMessage("Please fill out both fields.");
        return;
      }
      try {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const codesRef = collection(db, `artifacts/${appId}/public/data/redeemCodes`);
        await addDoc(codesRef, {
          ...newCode,
          isAvailable: true
        });
        setNewCode({ code: '', rewardDescription: '' });
        showModalMessage('New redeem code added successfully!');
      } catch (error) {
        console.error("Error adding new code:", error);
        showModalMessage("Failed to add new code.");
      }
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-semibold text-blue-400">Editor Dashboard</h2>
        
        {/* Section to add a new player review */}
        <div className={`rounded-lg p-6 shadow-xl space-y-4 ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
          <h3 className="text-xl font-semibold text-blue-400">Add New Player Review</h3>
          <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Fill in the details to add a new player review to the database.</p>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <input type="text" name="id" placeholder="Player ID (e.g., player-id)" value={newPlayer.id} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="text" name="name" placeholder="Name" value={newPlayer.name} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="text" name="position" placeholder="Position (e.g., ST, LW)" value={newPlayer.position} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="number" name="rating" placeholder="Rating" value={newPlayer.rating} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="text" name="image" placeholder="Image URL" value={newPlayer.image} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="number" name="weakFoot" placeholder="Weak Foot (1-5)" value={newPlayer.weakFoot} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="number" name="skillMoves" placeholder="Skill Moves (1-5)" value={newPlayer.skillMoves} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="number" name="stamina" placeholder="Stamina" value={newPlayer.stamina} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <input type="number" name="review.overallRating" placeholder="Overall Review Rating (1-10)" value={newPlayer.review.overallRating} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400" />
            <textarea name="review.strengths" placeholder="Strengths (comma-separated)" value={newPlayer.review.strengths} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 col-span-1 sm:col-span-2" rows="2" />
            <textarea name="review.weaknesses" placeholder="Weaknesses (comma-separated)" value={newPlayer.review.weaknesses} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 col-span-1 sm:col-span-2" rows="2" />
            <textarea name="review.summary" placeholder="Summary" value={newPlayer.review.summary} onChange={handleNewPlayerChange} className="p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 col-span-1 sm:col-span-2" rows="4" />
          </div>
          <button onClick={addNewPlayerReview} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-200 shadow-md">
            Add New Player Review
          </button>
        </div>
        
        {/* Section to remove existing player reviews */}
        <div className={`rounded-lg p-6 shadow-xl space-y-4 ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
          <h3 className="text-xl font-semibold text-blue-400">Remove Player Reviews</h3>
          <ul className="space-y-2">
            {playersData.map(player => (
              <li key={player.id} className="flex items-center justify-between p-3 rounded-lg bg-gray-800 text-gray-300">
                <span>{player.name} ({player.position})</span>
                <button onClick={() => removePlayerReview(player.id)} className="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-lg text-sm transition-colors duration-200">
                  Remove
                </button>
              </li>
            ))}
          </ul>
        </div>

        {/* Section for adding new redeem codes */}
        <div className={`rounded-lg p-6 shadow-xl space-y-4 ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
          <h3 className="text-xl font-semibold text-blue-400">Add New Redeem Code</h3>
          <input
            type="text"
            placeholder="Code (e.g., NEWCODE123)"
            value={newCode.code}
            onChange={(e) => setNewCode({ ...newCode, code: e.target.value })}
            className="w-full p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input
            type="text"
            placeholder="Reward Description (e.g., 500 Gems)"
            value={newCode.rewardDescription}
            onChange={(e) => setNewCode({ ...newCode, rewardDescription: e.target.value })}
            className="w-full p-2 rounded-lg bg-gray-700 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button onClick={addNewCode} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-200 shadow-md">
            Add New Code
          </button>
        </div>
      </div>
    );
  };

  // Contact page
  const ContactPage = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-semibold text-blue-400">Contact</h2>
      <div className={`rounded-lg p-6 shadow-xl space-y-4 text-center ${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-gray-200'}`}>
        <h3 className={`text-xl font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Connect with Us:</h3>
        <div className="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
          <a
            href="https://twitter.com"
            target="_blank"
            rel="noopener noreferrer"
            className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center"
          >
            <svg className="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M18.901 1.954c.78.293 1.25.996 1.25 1.791V20.25c0 .795-.47 1.498-1.25 1.791-.184.069-.37.106-.559.106-.398 0-.79.153-1.094-.457l-4.524-4.524a1.5 1.5 0 00-2.121 0l-4.524 4.524c-.304.304-.696.457-1.094.457-.189 0-.375-.037-.559-.106-.78-.293-1.25-.996-1.25-1.791V3.745c0-.795.47-1.498 1.25-1.791.184-.069.37-.106.559-.106.398 0 .79.153 1.094.457l4.524 4.524a1.5 1.5 0 002.121 0l4.524-4.524c.304-.304.696-.457 1.094-.457.189 0 .375.037.559.106zM9.5 10.5a.5.5 0 11-1 0 .5.5 0 011 0zm3 0a.5.5 0 11-1 0 .5.5 0 011 0z" />
            </svg>
            X (Twitter)
          </a>
          <a
            href="https://discord.com"
            target="_blank"
            rel="noopener noreferrer"
            className="bg-[#5865F2] hover:bg-[#7289DA] text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center"
          >
            <svg className="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10.744 1.298a.5.5 0 00-.518.069L.222 7.72a.5.5 0 00-.203.414v10.33a.5.5 0 00.203.414l9.904 6.353a.5.5 0 00.518.069l9.904-6.353a.5.5 0 00.203-.414V8.134a.5.5 0 00-.203-.414L11.262 1.367a.5.5 0 00-.518-.069zM15.432 17.588c-.626 0-1.134.508-1.134 1.134s.508 1.134 1.134 1.134 1.134-.508 1.134-1.134-.508-1.134-1.134-1.134zm-6.608 0c-.626 0-1.134.508-1.134 1.134s.508 1.134 1.134 1.134 1.134-.508 1.134-1.134-.508-1.134-1.134-1.134zM12 11.233a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zm-4.5 0a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" clipRule="evenodd" />
            </svg>
            Discord Server
          </a>
        </div>
      </div>
    </div>
  );

  // Renders the correct page based on the current state
  const renderPage = () => {
    switch (currentPage) {
      case 'home':
        return <HomePage />;
      case 'playerReviews':
        return <PlayerReviewsPage />;
      case 'top10Players':
        return <Top10PlayersPage />;
      case 'redeemCode':
        return <RedeemCodePage />;
      case 'contact':
        return <ContactPage />;
      case 'editor':
        return isEditor ? <EditorPage /> : <div className="text-center mt-20 text-xl text-red-500">Access Denied. You are not an editor.</div>;
      case 'playerDetail':
        return selectedPlayer ? <PlayerDetailPage /> : <PlayerReviewsPage />;
      default:
        return <HomePage />;
    }
  };

  return (
    <div className={`min-h-screen font-inter ${theme === 'dark' ? 'bg-[#121212] text-gray-200' : 'bg-gray-100 text-gray-800'}`}>
      {/* Head section with fonts and styles */}
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
          .font-inter { font-family: 'Inter', sans-serif; }
          .highlight-blue { color: #3b82f6; }
        `}
      </style>

      {/* Header Section */}
      <header className={`${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-white'} shadow-lg`}>
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <button onClick={() => setCurrentPage('home')} className="text-3xl font-bold highlight-blue">
            FC MOBILE COMMUNITY
          </button>
          <div className="flex items-center space-x-4">
            <button
              onClick={toggleTheme}
              className={`p-2 rounded-lg transition-colors duration-200 ${theme === 'dark' ? 'bg-gray-700 text-yellow-300' : 'bg-gray-300 text-gray-800'}`}
              title="Change Theme"
            >
              {theme === 'dark' ? '☀️' : '🌙'}
            </button>
            {user ? (
              <div className={`flex items-center space-x-2 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                <span>{user.uid}</span>
                <button
                  onClick={() => signOut(getAuth())}
                  className={`${theme === 'dark' ? 'bg-red-600 hover:bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow-md`}
                >
                  Log Out
                </button>
              </div>
            ) : (
              <>
                <button className={`${theme === 'dark' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow-md`}>
                  Log In
                </button>
                <button className={`${theme === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-300 hover:bg-gray-400'} text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow-md`}>
                  Register
                </button>
              </>
            )}
          </div>
        </div>
      </header>

      {/* Navigation Bar */}
      <Navigation />

      {/* Main Content Area */}
      <main className="container mx-auto mt-8 px-4 pb-12">
        {renderPage()}
      </main>

      {/* Footer Section */}
      <footer className={`${theme === 'dark' ? 'bg-[#1c1c1c]' : 'bg-white'} mt-12 py-6 text-center text-xs ${theme === 'dark' ? 'text-gray-500' : 'text-gray-600'}`}>
        <p>&copy; 2024 FC Mobile. All rights reserved.</p>
        <div className="mt-2 space-x-4">
          <a href="#" className="hover:text-blue-400">Terms of Service</a>
          <a href="#" className="hover:text-blue-400">Privacy Policy</a>
          <a href="#" className="hover:text-blue-400">Contact Us</a>
        </div>
      </footer>
    </div>
  );
}
